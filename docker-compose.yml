# Maintainer: Willis Chen <misweyu2007@gmail.com>
services:
  # Vector Database: Qdrant (Responsible for storing and retrieving security intelligence)
  cisco-foundation-sec-8b-qdrant:
    image: qdrant/qdrant:v1.17.0 # Recommended to use a specific version for stability
    container_name: cisco-foundation-sec-8b-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_storage:/qdrant/storage
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6333/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Initialization: Ensure nginx/.htpasswd is a file and not a directory (used for first deployment in gitignore scenario)
  htpasswd-init:
    image: busybox:stable
    container_name: security-app-htpasswd-init
    volumes:
      - ./nginx:/nginx
    # If .htpasswd does not exist (or was mistakenly created as a directory), auto-create a blank file
    command: >
      sh -c "
        if [ ! -f /nginx/.htpasswd ]; then
          touch /nginx/.htpasswd;
          echo '⚠️  nginx/.htpasswd does not exist, automatically created a blank file. Execute ./add_user.sh add <username> to add users.';
        fi
      "
    restart: "no"

  # Reverse Proxy: Nginx (Provides htpasswd basic authentication)
  nginx:
    image: nginx:alpine
    container_name: security-app-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      htpasswd-init:
        condition: service_completed_successfully
      security-app:
        condition: service_started

  # Security Application: Chainlit + Foundation-Sec-8B (GPU Accelerated)
  security-app:
    working_dir: /app
    build: .
    container_name: security-app-gpu
    restart: unless-stopped
    environment:
      # NVIDIA Container Configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

      # Application Parameters
      - QDRANT_URL=http://cisco-foundation-sec-8b-qdrant:6333
      - MODEL_SEC_PATH=/app/models/foundation-sec-8b-q4_k_m.gguf
      - MODEL_LLAMA3_PATH=/app/models/llama-3-taiwan-8b-instruct-q4_k_m.gguf

      # RTX 2060 6GB VRAM allocation strategy (Q4_K_M 8B has 32 layers each, ~140MB per layer):
      # - Llama-3-Taiwan (Classification+Translation): 10/32 layers on GPU -> ~1.26GB
      # - Foundation-Sec (Security Analysis): 15/32 layers on GPU -> ~1.87GB
      # - Two KV caches: ~0.48GB, compute buffer: ~1.34GB
      # - Total ~4.95GB, leaving ~1GB for CUDA context overhead and fragmentation
      # Note: If OOM still occurs, reduce N_GPU_LAYERS_SEC by 5
      - N_GPU_LAYERS_LLAMA3=5
      - N_GPU_LAYERS_SEC=10

      # Python/CUDA optimization for RTX 2060 6GB (Prevents memory fragmentation)
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

    # Hardware resource allocation: Pass GPU into container
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

    # Execution command (-w flag supports hot-reloading for development)
    command: chainlit run cisco_security_chainlit.py --host 0.0.0.0
    # Port 8000 is only open to the internal network, proxied by nginx, not directly exposed to host
    expose:
      - "8000"

networks:
  default:
    name: cisco_sec_net
